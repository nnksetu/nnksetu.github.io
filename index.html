<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>京东图床（批量）</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial; background:#f3f4f6; margin:0;padding:24px;}
  .card{max-width:900px;margin:18px auto;padding:18px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  h1{margin:0 0 12px;font-size:20px;}
  .drop{border:2px dashed #d1d5db;padding:28px;text-align:center;border-radius:8px;cursor:pointer;}
  .drop.drag{border-color:#10b981;background:#ecfdf5;}
  .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;}
  .thumb{width:110px;height:110px;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff;object-fit:cover;}
  .controls{display:flex;gap:10px;margin-top:14px;align-items:center;}
  button{padding:8px 12px;border:0;border-radius:6px;background:#0ea5a4;color:#fff;cursor:pointer;}
  button:disabled{opacity:.5;cursor:default}
  .list{margin-top:16px;}
  .item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:6px;border:1px solid #eef2f7;background:#fcfeff;margin-bottom:8px;}
  .url{flex:1;word-break:break-all;font-size:13px}
  .small{font-size:13px;color:#6b7280}
</style>
</head>
<body>
  <div class="card">
    <h1>京东图床（批量上传）</h1>
    <div id="drop" class="drop">点击或拖拽图片到此处（支持多选，单张 ≤ 5MB）</div>
    <input id="file" type="file" accept="image/*" multiple style="display:none;">
    <div class="preview" id="preview"></div>

    <div class="controls">
      <div class="small" id="status">未选择图片</div>
      <div style="flex:1"></div>
      <button id="uploadBtn">上传到京东图床</button>
      <button id="clearBtn" style="background:#ef4444">清除</button>
    </div>

    <div class="list" id="resultList"></div>

    <div class="small" style="margin-top:10px;color:#666">
      注意：第三方 API 单张限制 5MB；若上传时控制台出现跨域（CORS）错误，请使用后端代理（示例见下）。
    </div>
  </div>

<script>
const API_URL = 'https://api.xinyew.cn/api/jdtc'; // doc 指出的接口地址
const drop = document.getElementById('drop');
const input = document.getElementById('file');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const uploadBtn = document.getElementById('uploadBtn');
const clearBtn = document.getElementById('clearBtn');
const resultList = document.getElementById('resultList');

let files = [];

// Helper: show previews
function renderPreview(){
  preview.innerHTML = '';
  if(files.length === 0){
    status.textContent = '未选择图片';
    return;
  }
  status.textContent = `已选择 ${files.length} 张图片`;
  files.forEach((f, i)=>{
    const el = document.createElement('div');
    el.className = 'thumb';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(f);
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    el.appendChild(img);
    preview.appendChild(el);
  });
}

// validate and set files
function setFiles(fileList){
  const arr = Array.from(fileList);
  const ok = [];
  for(const f of arr){
    if(!f.type.startsWith('image/')) continue;
    if(f.size > 5 * 1024 * 1024){
      alert(`文件 ${f.name} 超过 5MB，已跳过`);
      continue;
    }
    ok.push(f);
  }
  files = ok;
  renderPreview();
}

// drag & drop
drop.addEventListener('click', ()=>input.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=>drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('drag'); setFiles(e.dataTransfer.files); });

// input change
input.addEventListener('change', ()=> setFiles(input.files) );

// clear
clearBtn.addEventListener('click', ()=>{
  files = []; input.value=''; preview.innerHTML=''; resultList.innerHTML=''; status.textContent='未选择图片';
});

// upload sequence (to avoid parallel issues)
uploadBtn.addEventListener('click', async ()=>{
  if(files.length === 0){ alert('请先选择图片'); return; }
  uploadBtn.disabled = true; uploadBtn.textContent = '上传中...';
  resultList.innerHTML = '';

  for(let i=0;i<files.length;i++){
    const file = files[i];
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div style="width:90px">${file.name}</div><div class="url">上传中...</div>`;
    resultList.appendChild(row);

    try{
      const fd = new FormData();
      fd.append('file', file); // 接口要求字段名 file
      // 使用 POST 发送 multipart/form-data
      const resp = await fetch(API_URL, { method:'POST', body: fd });
      if(!resp.ok){
        row.querySelector('.url').textContent = `HTTP ${resp.status}`;
        continue;
      }
      const json = await resp.json();
      if(json && (json.errno === 0 || json.errno === '0')){
        const url = json.data && json.data.url ? json.data.url : JSON.stringify(json);
        row.querySelector('.url').innerHTML = `<a href="${url}" target="_blank">${url}</a> <button data-url="${url}">复制</button>`;
      } else {
        const msg = json && json.message ? json.message : JSON.stringify(json);
        row.querySelector('.url').textContent = `失败：${msg}`;
      }
    }catch(err){
      // 很可能是 CORS 或 网络错误
      row.querySelector('.url').textContent = '错误：' + (err.message || err);
      console.error(err);
    }
  }

  // attach copy handlers
  resultList.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const u = btn.getAttribute('data-url');
      navigator.clipboard.writeText(u).then(()=>{ btn.textContent='已复制'; setTimeout(()=>btn.textContent='复制',1200); });
    });
  });

  uploadBtn.disabled = false; uploadBtn.textContent = '上传到京东图床';
});

</script>
</body>
</html>