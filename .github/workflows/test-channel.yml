import os
import requests
import json
from datetime import datetime

TOKEN = os.environ['TELEGRAM_BOT_TOKEN']
CHAT_ID = os.environ['TELEGRAM_CHANNEL_CHAT_ID']
CHANNEL_USERNAME = "setutime_pipi"

def get_file_download_url(file_id):
    url = f"https://api.telegram.org/bot{TOKEN}/getFile?file_id={file_id}"
    resp = requests.get(url).json()
    if resp['ok']:
        file_path = resp['result']['file_path']
        return f"https://api.telegram.org/file/bot{TOKEN}/{file_path}"
    return "(è·å–å¤±è´¥)"

def main():
    print("=== è¶…çº§è°ƒè¯•ç‰ˆï¼šå¼€å§‹è¯»å–é¢‘é“æ¶ˆæ¯ ===")
    print(f"é¢‘é“ç”¨æˆ·å: @{CHANNEL_USERNAME}")
    print(f"é¢‘é“ Chat ID: {CHAT_ID}")
    print(f"å½“å‰æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} JST\n")

    offset = None
    found = 0

    # åªå¾ªç¯ä¸€æ¬¡ï¼ˆGitHub Actions ä¸é€‚åˆæ— é™è½®è¯¢ï¼‰ï¼Œä½†ç”¨é•¿ timeout ç­‰æ–°æ¶ˆæ¯
    params = {
        'offset': offset,
        'limit': 100,
        'timeout': 60,  # ç­‰ 60 ç§’ï¼Œçœ‹èƒ½ä¸èƒ½ç­‰åˆ°æ–°æ¶ˆæ¯
        'allowed_updates': json.dumps(['channel_post', 'edited_channel_post'])  # å…³é”®ï¼å¼ºåˆ¶åªæ¥æ”¶é¢‘é“æ¶ˆæ¯
    }

    print("æ­£åœ¨è°ƒç”¨ getUpdatesï¼Œå‚æ•°:", params)
    response = requests.get(f"https://api.telegram.org/bot{TOKEN}/getUpdates", params=params, timeout=70)
    data = response.json()
    print("Telegram è¿”å›å®Œæ•´ JSON:", json.dumps(data, indent=2, ensure_ascii=False))

    if not data['ok']:
        print("API é”™è¯¯ï¼è¯·æ£€æŸ¥ Token æˆ–ç½‘ç»œ")
        return

    updates = data['result']
    print(f"æœ¬æ¬¡æ”¶åˆ° {len(updates)} æ¡ updates")

    for update in updates:
        post = update.get('channel_post') or update.get('edited_channel_post')
        if not post or str(post['chat']['id']) != CHAT_ID:
            continue

        found += 1
        msg_id = post['message_id']
        link = f"https://t.me/{CHANNEL_USERNAME}/{msg_id}"
        text = post.get('text') or post.get('caption') or '(æ— æ–‡å­—)'

        print(f"âœ… æˆåŠŸè¯»å–åˆ°é¢‘é“æ¶ˆæ¯ï¼ID: {msg_id}")
        print(f"   æ°¸ä¹…é“¾æ¥: {link}")
        print(f"   å†…å®¹: {text}")

        if 'document' in post:
            doc = post['document']
            name = doc.get('file_name', 'æœªçŸ¥æ–‡ä»¶')
            file_url = get_file_download_url(doc['file_id'])
            print(f"   ğŸ“¦ å‹ç¼©åŒ…: {name}")
            print(f"   ğŸ“ æ–‡ä»¶ç›´é“¾: {file_url}")

        # æ›´æ–° offsetï¼Œé¿å…ä¸‹æ¬¡é‡å¤
        if 'update_id' in update:
            offset = update['update_id'] + 1

    print(f"\n=== æœ¬æ¬¡è¿è¡Œç»“æŸ === æ‰¾åˆ° {found} æ¡é¢‘é“æ–°æ¶ˆæ¯")

if __name__ == '__main__':
    main()
